# CHANGELOG

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

> 古い履歴（文字化けを含む旧版保管）は `CHANGELOG_legacy.md` を参照してください。

---

## [Unreleased]
### Changed
#### Lightbox / 書庫プレビュー
- 書庫プレビューフレームの Lightbox 取得数とキャッシュ生成目標数を `12` から `6` に調整（サンプリング方式は維持）。
- Lightbox（書庫プレビュー）で情報パネルとプレビュー領域の見た目を分離し、グリッドのサイズ感・余白を調整。
- Lightbox の `×` / `Esc` / 背景クリックを段階動作に調整（書庫プレビュー単独表示中は一覧へ戻り、一覧時は Lightbox を閉じる）。
- Lightbox 情報パネルに大きめのファイル名表示を追加し、書庫プレビュー操作時の識別性を改善。
- 右サイドバー / Lightbox のタグバッジ表示でカテゴリ色が反映されるよう改善（カテゴリ色返却 + タグ色解決）。
#### FileCard / 表示モード
- FileCard 表示モード定義を `src/components/fileCard/displayModes.ts` に分離し、`FileGrid` / `SortMenu` と共有する構成へ整理。
- FileCard の情報欄を `FileCardInfoArea` / `FileCardInfoCompact` / `FileCardInfoDetailed` に分離し、モード別UI調整の保守性を改善。
- 表示モードラベルとメニュー構成を整理（`標準（S/簡易）` / `標準（M）` / `標準（L）` / `動画（ワイド）` / `漫画`）。
- 漫画モードの表示バランスを調整（`2:3` 維持、`cardWidth=210` 採用、漫画モード専用の情報欄余白配分を追加）。
- 標準（M/L）FileCard の情報欄バランスを調整（情報欄高さの微増、メタ行の行間調整、タグ行の下寄せ、サイズバッジとタグの整列感改善）。
- 標準（M/L）と漫画モードの詳細情報欄を同型化し、2段目を `サイズ / 作成日 / フォルダ名` のバッジ列、下段をタグ要約（右寄せ）に整理。
- 標準（M/L）と漫画モードのタグ要約バッジを再調整（チップ高さ・幅上限・表示文字量の拡張、漫画は件数/幅をやや控えめに設定）。
- 標準（M/L）/ 漫画モードの情報欄高さを再調整（`80 / 80 / 76`）し、バッジ化後の詰まりを回避。
- 動画（ワイド）モードの詳細情報欄も同型レイアウトへ寄せ、2段目バッジ列化と情報欄高さ調整（`70 -> 76`）でファイル名が潰れやすい問題を改善。
- FileCard の詳細情報欄リファクタを段階的に整理し、モード別UI設定（`getDetailedInfoUiConfig` / `getTagSummaryUiConfig`）、2段目バッジ列/下段行の小分け、タグ要約描画・受け渡し（`TagSummaryRenderer`）の責務分離を進めた（見た目変更なし）。
- サムネイルホバー動作に `自動パラパラ` モードを追加し、動画プレビューフレームを hover 中に自動送りで表示できるようにした（`スクラブ` のプリロード経路と進捗バー表示を共通化）。
- `自動パラパラ` の速度設定（`遅い / 標準 / 速い`）を追加し、プレビューフレーム枚数に応じた見え方を調整しやすくした。
- 一覧のアニメーション画像（GIF / アニメーションWebP）にホバープレビューを追加し、ホバー時のみ元ファイルを表示して再生できるようにした（設定で `オフ / ホバーで再生` 切替、パフォーマンスモード時は無効）。
#### プロファイル / スキャン設定
- 各プロファイルDBに `profile_settings` テーブル（`profile_scoped_settings_v1`）を追加し、プロファイル別設定の保存基盤を実装（初回対象: `対応形式カテゴリON/OFF` / `プレビューフレーム数`）。
- `profileSettings:get/set/replace` IPC と preload / renderer API を追加し、起動時・プロファイル切替時にアクティブプロファイルの設定を読み込んで UI とスキャナ実行時設定へ同期するよう改善。
- 設定画面のサムネイルタブに「プロファイル別スキャン設定」を追加し、`動画 / 画像 / 書庫 / 音声` のカテゴリON/OFFと `プレビューフレーム数` を現在プロファイル単位で保存できるようにした（`thumbnailResolution` / `scanThrottleMs` は全体設定のまま維持）。
- プロファイル別設定導入時の初回移行フローを追加し、既存のプレビューフレーム数を引き継ぐか既定値で開始するかを選べる簡易ダイアログを表示するようにした。
- 設定画面に `スキャン` タブを追加し、`対応形式（カテゴリON/OFF）` をサムネイル設定から分離。`プレビューフレーム数` はサムネイルタブに残しつつ、プロファイル別設定である旨の文言を明確化。
- プロファイル別設定対象を拡張し、`サムネイル解像度`（サムネイルタブ）と `スキャン速度調整`（スキャンタブ）も現在プロファイル単位で保存・切替されるようにした。
#### コンテキストメニュー / 別モードで開く
- ファイルコンテキストメニューに `別のモードで開く` 基盤を追加し、初回として書庫（音声入り）に `音声書庫として開く` を実装。DBの型は変更せず、Lightbox を音声優先表示で開けるようにした。
#### タグ表示 / タグ管理
- FileCard の要約タグ表示でカテゴリ偏りを抑える選択ロジックを追加し、少数表示時にカテゴリの見え方バランスを改善（未分類タグは後順位）。
- タグ管理モーダルのタグ管理タブをレイアウト整理（右ペインの情報区分・余白・一覧カード化）。「表示優先順位の基準」は常設表示をやめて情報ボタンのポップアップへ移し、タグ順のルール説明を必要時のみ確認できる構成に整理。
- タグ管理モーダルのタグ一覧でドラッグ並び替えを追加し、表示優先順を直感的に調整できるよう改善（カテゴリは従来どおりドラッグ順）。
- タグ管理モーダルのアイコン名入力に候補補完（datalist）とクイック選択を追加し、タグアイコン設定を行いやすく改善。
- 左サイドバーのタグ検索フィルターと、右サイドバー/Lightbox の `TagSelector` 選択済みタグ表示をカテゴリ順・タグ順ベースで安定表示するよう調整（表示優先順の反映範囲を拡大）。
- FileCard の要約タグ表示でカテゴリ順（カテゴリ表示順）を基準にした並びを反映し、長いタグ名はチップ内で省略表示してレイアウト崩れを抑制。
- 設定画面に「ファイルカード要約タグの並び」オプションを追加し、`カテゴリ分散` / `厳密順（カテゴリ順→タグ順）` を切り替え可能にした。
#### バックアップ / インポート・エクスポート
- 設定画面のバックアップタブに一覧エクスポート（`CSV` / `HTML`）を追加し、`プロファイル全体` / `現在選択フォルダ全体` を選んで保存ダイアログ経由で出力できる MVP を実装（CSV は UTF-8 BOM付き、HTML は簡易テーブル、タグ色を含む）。
- 設定画面のバックアップタブに「このアプリ形式CSV」のインポート（タグ復元・追記型）を追加し、CSV選択→Dry Run（一致件数/未一致/新規タグ作成予定）→適用の流れで `path` キーによりタグを復元できるようにした。
- エクスポート欄に「インポート対応はCSVのみ（HTMLは閲覧用）」の注記を追加し、CSVインポート欄を旧アプリ互換モード（Shift_JIS / 可変列）にも対応。旧CSVは `コメント１` をメモへ追記し、末尾の追加列をタグ/星評価候補として解釈するルールを採用。Dry Run で一致/未一致・タグ付与予定・評価更新予定・メモ追記予定を確認でき、適用時はタグ追記に加えて星評価を総合評価軸へ取り込めるようにした。
#### ドキュメント / 開発運用
- `docs/dev/回帰確認チェックリスト.md` を追加し、表示モード（標準 S/M/L・漫画・動画）中心の最低限の回帰確認観点を整理。
- Electron 起動ログにビルド識別情報（`version / runtime(dev|release) / exe更新時刻 / Electron/Chrome/Node 版`）を出力する `build marker` を追加。
- 開発版/リリース版でアイコンを分離する設定を追加（開発版は `BrowserWindow` アイコン、リリース版は `electron-builder` の Windows アイコン設定）。
- `README.md` / `docs/user/アプリ使用メモ.md` の更新手順とリリース手順を整理し、`update.bat` 更新後の最小確認項目・失敗時の簡易切り分けを追記。
#### ログ / エラー表示
- 設定画面のログタブに「表示中をコピー」操作と共有案内を追加し、非エンジニア向けの問い合わせ時にログ共有しやすく改善。
- ログ読み込み失敗時の案内を詳細化し、`ログなし` と `フィルター結果なし` を区別して表示するように調整。

### Fixed
#### 配布 / 更新運用
- `update.bat` の ZIP更新処理を修正し、`robocopy` 宛先パスの末尾バックスラッシュによる引数解釈崩れと、エラー表示文の括弧未エスケープで更新後に `". was unexpected at this time."` が出る問題を改善（`update.bat` 自己上書きも回避）。
#### サムネイル保存管理 / 互換
- サムネイル cleanup 診断の旧保存構造フォールバック時に、全プロファイルDB参照を集約してプロファイル跨ぎ誤検出を抑制。
- 孤立サムネイル診断/削除で、書庫プレビュー固定キャッシュ（`archive-preview`）を孤立判定対象から除外。
- 保存場所切替時の `thumbnail_path` / `preview_frames` パス更新判定を `instr()` ベースに調整（JSON配列/カンマ区切り形式差に配慮）。
- `media://` で `thumbnails` 配下の古い絶対パスを参照した場合、現在の保存先（`getBasePath()`）配下へフォールバック解決するよう改善（移行後の表示復旧性向上）。
- フォルダカード代表サムネイル取得で、古い `thumbnail_path` による `404` を避けるため、各フォルダ内で実在するサムネイル候補を優先採用するよう改善。
#### 表示モード / レイアウト
- 表示モード切替直後に発生するグリッドの一時レイアウト崩れを抑えるため、仮想行サイズの再計測を追加。
- `FileCard` の aspect-ratio 描画化に伴い、`動画（ワイド）` / `標準（S/簡易）` の `aspectRatio` 定義不整合で情報欄が崩れる問題を修正。
#### スキャン / プロファイル設定
- プロファイル別の対応形式をOFFにした後の再スキャンで、無効カテゴリの既存DB登録が残り続ける問題を修正し、`db.deleteFile()` 経由で関連サムネイル/プレビューを含めて整理するようにした（物理ファイル本体は削除しない）。
#### インポート反映
- CSVインポートで星評価を取り込んだ直後に星評価フィルターへ反映されない場合がある問題に対して、インポート完了後に評価キャッシュ（`useRatingStore`）を再読込するよう修正。

---

## [1.1.3d5] - 2026-02-22
### Changed
- サムネイル保存管理の整理を進め、主要生成系（画像 / 動画 / 音声 / 書庫 / 動画プレビュー）を新しい保存構造へ統一。
- 書庫サムネイルを WebP 変換して保存するように変更（失敗時は元形式へフォールバック）。
- 書庫プレビューフレームを WebP 化し、`thumbnails/profiles/<profile>/archive-preview` 配下へ保存するように変更。
- 書庫プレビューフレームを固定キャッシュ化し、右サイドバー（4枚）/ Lightbox（12枚）で再利用するよう改善。
- WebP 品質値を内部プリセット化（`image / video / archive / previewFrame` を分離）。
- 書庫プレビューフレームの最終設定を `384px` / `previewFrame=40` に調整（Lightbox 表示と容量のバランス）。
- `AGENTS.md` を追加し、Windows + PowerShell の UTF-8 / 文字化け対策ルールを明文化。

### Fixed
- 書庫サムネイル生成の安定性改善（初回スキャン失敗、`EXDEV`、`ENOENT`、同名衝突、フォールバック経路）。
- 開発版で `7za.exe` を見つけられず書庫プレビュー/サムネイルが生成できない問題（パス解決の見直し）。
- 統計画面のサムネイル容量表示が新旧保存構造の切替中に `0` になりやすい問題（旧構造フォールバック）。
- サムネイル cleanup / 削除処理で `preview_frames` の形式差（JSON配列 / カンマ区切り）により取りこぼす問題。
- タグ管理モーダルで UI が消える問題（Portal 化 + Hook 順序エラー修正）。

---

## [1.1.3] - 2026-02-21
### Changed
- タグ UI の操作性を改善（TagSelector / TagManagerModal 周辺）。
- 各種リリース調整（並び順・表示まわり）。

### Fixed
- リリース版で `7za.exe` の参照に失敗する問題。
- `mode=install` 周辺の DB / 保存先まわりの不整合。
- パッケージング後の実行で発生する不具合の修正（`afterPack` 周辺）。

---

## [1.1.2] - 2026-02-19
### Note
- この版以前の詳細履歴は `CHANGELOG_legacy.md` を参照してください（旧ファイルに文字化けを含みます）。

---

## [1.1.0] - 2026-02-18
### Note
- 初期の詳細履歴は `CHANGELOG_legacy.md` を参照してください。

# AGENT.md

## 目的

この AGENT.md は、本プロジェクト（MediaArchiver v2）において
AI が実装・修正・提案を行う際の
**最優先の行動規範（Operating Rules）**を定義する。

本ファイルの内容は、他のすべてのドキュメントより優先される。

---

## ドキュメントの優先順位

AI は以下の順で内容を解釈・遵守すること。

1. **AGENT.md**（本ファイル）
2. **implementation_plan.md**（実装計画）
3. **ARCHITECTURE.md**（システム構成）
4. **ROADMAP.md**（機能ロードマップ）
5. **CONVENTIONS.md**（コーディング規約）
6. **Glossary.md**（用語集）
7. その他補足資料

内容が矛盾する場合は、上位のドキュメントを優先する。

---

## 基本方針

- **安定性・再現性を最優先とする**
- **UI 表示よりデータ整合性を優先する**
- **「動くこと」より「壊れないこと」を優先する**
- **既存の動作を暗黙に変更してはならない**

---

## 明確な禁止事項（重要）

以下の行為を **行ってはならない**。

### UI・パフォーマンス関連
- ❌ **hover イベントで React state を更新すること**
  - 理由: v1で点滅問題を引き起こした主要因
  - 例外: `useUIStore` の `hoveredFileId` のみ許可（分離設計済み）
  
- ❌ **仮想スクロール中に DOM サイズ・レイアウトを変更すること**
  - 理由: TanStack Virtual は固定高さを前提とする
  - 禁止例: カード高さの動的変更、アニメーションによる高さ変化
  
- ❌ **requestAnimationFrame / setInterval による自動 UI 更新を**
  **ユーザー操作なしで開始すること**
  - 理由: 再描画の無限ループを引き起こす可能性
  - 例外: ユーザーが明示的に開始したプレビュー再生のみ

### 実装方針関連
- ❌ **implementation_plan.md に記載のない仕様を独自に追加すること**
  - 理由: スコープクリープと予期しない副作用を防ぐ
  - 原則: 「書かれていないことはやらない」
  
- ❌ **データ削除・GC 処理を確認 UI なしで実装すること**
  - 理由: データ損失リスクが高い
  - 必須: 削除対象のプレビュー表示 + 確認ダイアログ

### コーディング規約違反
- ❌ **Zustand ストアを `const store = useStore()` で取得すること**
  - 正: `const files = useFileStore((s) => s.files)`
  - 理由: 不要な再描画を引き起こす

### ファイルシステム操作
- ❌ **`fs.rm`, `fs.unlink`, `fs.rmdir` を try-catch なしで呼び出すこと**
- ❌ **削除対象が10件を超える一括削除を確認なしで実行すること**
- ❌ **ユーザーのホームディレクトリ外のファイルを操作すること**
- ❌ **`app.getPath()` 以外のパスでファイル書き込みを行うこと**

### IPC通信
- ❌ **無限ループを引き起こす可能性のある再帰的IPC呼び出し**
- ❌ **1回のIPC呼び出しで1000件以上のデータを返すこと**
  - 原則: ページネーションまたはストリーミングを使用
- ❌ **Main→Renderer への一方的なイベント連射（debounce/throttle なし）**

### データベース操作
- ❌ **DELETE 文を WHERE 句なしで実行すること**
- ❌ **UPDATE 文で全レコードにマッチする可能性がある場合に確認なしで実行**
- ❌ **マイグレーションをロールバック手順なしで実装すること**
- ❌ **本番DBに対して直接 SQL を実行すること（必ず関数経由）**

### 並列処理
- ❌ **p-limit なしで並列ファイル処理を実行すること**
  - 上限: サムネイル生成は同時3件、ハッシュ計算は同時5件
- ❌ **Promise.all で100件以上のPromiseを同時実行すること**
- ❌ **Worker Thread / Utility Process を未承認で追加すること**

### エラーハンドリング
- ❌ **catch ブロックでエラーを握りつぶすこと（最低限 console.error 必須）**
- ❌ **ユーザー向けエラーメッセージなしで処理を中断すること**
- ❌ **`electron-log` を使用せずにエラーログを出力すること**

### 外部通信
- ❌ **fetch / axios で外部URLにリクエストを送信すること**
  - 例外: FFmpeg/Sharp のバイナリダウンロード（初回セットアップのみ）
- ❌ **Electron の webSecurity を無効化する設定を追加すること**

---

## 実装停止条件（即座停止・報告必須）

以下の状況が発生した場合、**実装を即座に停止**し、ユーザーに報告すること。

1. **既存のテスト・ビルドが失敗した場合**
2. **implementation_plan.md に記載されていない判断が3回以上必要になった場合**
3. **既存ファイルの50行以上を一度に変更する必要がある場合**
4. **新規ファイルを5つ以上作成する必要がある場合**
5. **DBスキーマの変更が必要になった場合**
6. **IPC チャンネルの新規追加が3つ以上必要になった場合**
7. **外部ライブラリの追加・更新が必要になった場合**
8. **想定外のエラーが連続して3回以上発生した場合**

---

## セッション境界ルール

- ❌ **前回セッションの implementation_plan.md を確認せずに実装を継続すること**
- ❌ **セッション開始時に `/start` を実行せずに実装を開始すること**
- ❌ **1セッションで3つ以上のPhase項目を同時に着手すること**
- ❌ **セッション終了時に `/update-docs` を実行せずに終了すること**

---

## 拡大解釈・抜け道の防止

以下は長期運用で破られやすいルールであり、厳格に遵守すること。

### 例外の濫用防止
- ❌ **「例外」を自己判断で適用すること**
  - 本ファイルに明記された例外以外は全て禁止扱いとする
  - 「これも例外に該当するはず」という推論は禁止
- ❌ **「軽微な変更」を理由に禁止事項を回避すること**
  - 1行の変更でも禁止事項は適用される

### 承認の厳格化
- ❌ **口頭指示のみで implementation_plan.md を省略すること**
  - 高リスク領域は必ず文書化が必要
- ❌ **「前回承認された」を根拠に類似機能を無断追加すること**
  - 承認は機能単位であり、類推適用は禁止

### リファクタリングの制限
- ❌ **リファクタリングを名目に外部挙動を変更すること**
  - 入出力が変わる変更はリファクタリングではない
- ❌ **「コード整理」で未使用コードを削除すること**
  - 削除は明示的な承認が必要

### 提案の制限
- ❌ **依頼されていない改善提案を3つ以上列挙すること**
  - 提案は最大2つまで、簡潔に
- ❌ **実装中に「ついでに」別の改善を行うこと**
  - スコープ外の変更は禁止

### 効率化の制限
- ❌ **「効率化のため」確認ダイアログを省略すること**
- ❌ **「パフォーマンス向上のため」エラーハンドリングを省略すること**
- ❌ **「シンプルにするため」ログ出力を省略すること**

### 緊急対応の制限
- ❌ **「緊急」を理由に implementation_plan.md を省略すること**
  - 緊急時でも最低限の影響範囲記載は必須
- ❌ **「一時的な修正」を理由にドキュメント更新を省略すること**

### ドキュメント更新の強制
- ❌ **「後で更新する」を理由にセッション中のドキュメント更新を怠ること**
  - ドキュメント更新はセッション終了前に必須
- ❌ **CHANGELOG.md への記載を怠ること**
  - 機能追加・バグ修正は必ず記載

### 既存パターンの盲従防止
- ❌ **既存コードが AGENT.md に違反している場合、それを踏襲すること**
  - 既存コードより AGENT.md が優先
  - 違反を発見した場合は報告必須

---

## 高リスク領域の扱い

以下は過去に不具合が発生した高リスク領域である。

### 1. サムネイル hover / scrub / 自動再生
- **問題**: v1で点滅・フリーズ問題が発生
- **原則**: hover時の状態更新は `useUIStore` のみに限定
- **禁止**: `useFileStore` や `useSettingsStore` の更新

### 2. 仮想スクロールと UI アニメーションの組み合わせ
- **問題**: レイアウトシフトによるスクロール位置のズレ
- **原則**: カード高さは固定（`CARD_HEIGHT` 定数を使用）
- **禁止**: アニメーションによる高さ変化

### 3. ファイル・サムネイルの自動削除処理
- **問題**: データ損失リスク
- **原則**: 必ず事前プレビュー + 確認ダイアログ
- **禁止**: 自動実行、バックグラウンド削除

これらを含む実装では：

- ✅ 事前に implementation_plan.md の明示的な記述が必要
- ✅ 不明点があれば実装を止め、質問すること
- ❌ 「簡易実装」「とりあえず動かす」は禁止

---

## 実装フロー

### 1. セッション開始時
```
/start → ARCHITECTURE.md, CONVENTIONS.md, ROADMAP.md, Glossary.md を確認
```

### 2. 新規機能実装時
```
1. ROADMAP.md で対象フェーズとリスク区分を確認
2. /plan を実行し、implementation_plan.md を作成
3. ユーザーの承認を得る
4. implementation_plan.md の内容を厳守して実装
5. /update-docs で関連ドキュメントを更新
```

### 3. 不具合修正時
```
1. 不具合の影響範囲を特定
2. 修正方針を明示（implementation_plan.md または口頭確認）
3. 既存挙動の変更点がある場合は明示する
4. 修正後、関連する不具合リストを更新
```

### 4. 実装中の原則
- 仕様に書かれていない挙動は実装しない
- 既存挙動の変更点がある場合は明示する
- テストは必ず手動で確認する（自動テストは未整備）

---

## 期待されるAIの役割

AIは「設計者」ではなく、
**与えられた設計を正確に実装する実行者**として振る舞うこと。

### ✅ 期待される行動
- 仕様の不明点を質問する
- 実装前にリスクを指摘する
- 既存コードのパターンに従う
- ドキュメントを最新に保つ

### ❌ 避けるべき行動
- 仕様にない機能を「便利だから」追加する
- 「多分こうだろう」で実装を進める
- 既存のパターンを無視して独自実装する
- ドキュメント更新を怠る

判断が必要な場合は、
勝手に補完せず、確認を求めること。

---

## プロジェクト固有の重要事項

### 技術スタック
- **Frontend**: React 18 + TypeScript + Vite
- **State**: Zustand（再描画最適化のためセレクタ形式必須）
- **Virtual Scroll**: TanStack Virtual（固定高さ前提）
- **Backend**: Electron Main Process + SQLite
- **IPC**: contextBridge経由の型安全通信

### アーキテクチャの制約
- Main/Renderer プロセス分離を厳守
- IPC通信は `electron/ipc/` 配下で定義
- ビジネスロジックは `electron/services/` に配置
- UI状態は Zustand ストアで一元管理

### パフォーマンス要件
- 10,000件以上のファイル表示でも快適動作
- サムネイル生成は同時実行数制限（p-limit使用）
- タグ取得は一括取得（N+1問題の回避）

### データ整合性要件
- ファイル削除時はサムネイルも削除
- トランザクション処理でDB整合性を保証
- エラーは `electron-log` で永続化

---

## よくある質問（FAQ）

### Q: 新しいUIアニメーションを追加したい
A: まず ROADMAP.md でリスク区分を確認。Phase 12-A（データ非破壊）なら比較的安全。hover時の状態更新は避けること。

### Q: 既存機能の改善案がある
A: implementation_plan.md に記載し、ユーザー承認を得ること。独断での変更は禁止。

### Q: テストはどうすればいい？
A: 現在は手動テスト。実装後に動作確認し、問題があれば報告。

### Q: ドキュメントが古い場合は？
A: `/update-docs` を実行して更新。矛盾がある場合は AGENT.md > implementation_plan.md の順で優先。

---

## 改訂履歴

- 2026-02-05: 初版作成（セカンドオピニオンAIとの議論を反映）
- 2026-02-05: 追加禁止事項・停止条件を追加
  - ファイルシステム操作、IPC通信、DB操作、並列処理、エラーハンドリング、外部通信の禁止事項
  - 実装停止条件（8項目）
  - セッション境界ルール（4項目）
- 2026-02-05: 拡大解釈・抜け道防止ルールを追加
  - 例外の濫用防止、承認の厳格化、リファクタリングの制限
  - 提案の制限、効率化の制限、緊急対応の制限
  - ドキュメント更新の強制、既存パターンの盲従防止

# AGENTS

## 文字コードルール（Windows / PowerShell）

- Markdown / テキストファイルは `UTF-8` を前提に扱う
- `PowerShell` で読み書きする場合は、文字コードを明示する
- `Get-Content` / `Set-Content` / `Out-File` を使うときは `UTF-8` 指定を省略しない
- 文字化けしやすいファイル（`CHANGELOG.md`, `ROADMAP.md`, `docs/*.md`）は `apply_patch` を優先する

## PowerShell 実行時の実務ルール

- 読み込み: `Get-Content -Encoding UTF8`
- 書き込み: `Set-Content -Encoding utf8`
- .NET API で書く場合は `UTF8Encoding($false)` を使い、BOM有無を明示する

## 追記・置換の注意

- 文字化けした表示を見たまま置換しない（意図しない差分が出やすい）
- 大きいテキスト置換をする前に `git diff --stat` で差分量を確認する
- 不自然に差分が大きい場合は作業を止めて、エンコード起因を疑う

# ROADMAP 運用ルール（Codex向け）

## 基本方針

- ROADMAP には「進行中」と「予定」のみ記載する
- 完了した項目は **即削除**し、CHANGELOG に移す
- 詳細は CHANGELOG に書く。ROADMAP には書かない

---

## 記述ルール

### 1. 1項目は1行で書く

- 説明・補足・経緯は ROADMAP には書かない
- 詳細が必要なら CHANGELOG に書き、ROADMAP からは参照しない
- タスク名の後に（）で目的・解決意図を一文以内で添えることを推奨する
- 経緯・実装詳細・補足は書かない。あくまで「何のためか」だけに限定する

**NG例:**
```
- サムネイル保存管理の再設計（Step 2 追加）: 書庫サムネイルを優先 WebP 保存へ変更し、
  容量削減と形式の一貫性を改善（変換失敗時は元形式フォールバック）
```

**OK例:**
```
- サムネイル保存管理 Step 2: 書庫サムネイル WebP 化（進行中）
- 左サイドバーのフォルダツリー表示（登録フォルダを階層で俯瞰して絞り込みやすくする）
- ffmpeg Worker 化（スキャン中のUI固まりを解消するためメインスレッドから分離）
```

---

### 2. 項目数の上限を守る

| セクション | 上限 |
|-----------|------|
| 進行中    | 5項目 |
| 予定（直近）| 5項目 |
| 予定（将来候補）| 10項目 |

- 上限を超える場合は、完了済みを削除するか Backlog に送る
- 上限を超えてでも追記することは禁止

---

### 3. 完了したら即削除する

- 「完了」「実質完了」「確認済み」になった項目は ROADMAP から削除し、CHANGELOG に移す
- 「完了欄」「最近完了した項目」のような保管セクションを ROADMAP に作らない
- ROADMAP と CHANGELOG の両方に同じ内容を書かない

---

### 4. 「進行中」セクションのルール

- 現在アクティブに作業している項目のみ記載する
- 作業が止まっている・保留中の項目は「予定」か Backlog に移す
- セッション開始時に「進行中」を確認し、完了済みは即削除すること

---

## セクション構成（テンプレート）

```markdown
## 進行中 (In Progress)
- [タスク名]: [一言で状態]
- ...（最大5項目）

## 予定 (Planned)
### 直近
- [タスク名]
- ...（最大5項目）

### 将来候補
- [タスク名]（コスト: 低/中/高、リスク: 低/中/高）
- ...（最大10項目）

## Backlog
- [タスク名]
```
# CHANGELOG 運用ルール（Codex向け）

## 基本方針

- CHANGELOG はユーザー・開発者が「何が変わったか」を把握するためのものとして書く
- 実装詳細（変数名・関数名・IPC名・内部構造）は原則書かない
- 純粋なリファクタリングで表示・動作への影響がない場合は、記載するとしても「（表示への変更なし）」と末尾に添えるだけにとどめるか、省略する

---

## 記述ルール

### 1. 「何が変わったか」をユーザー視点で一文にまとめる

実装の手段ではなく、変更の結果・効果を書く。

**NG例:**
```
FileCard の詳細情報欄リファクタを段階的に整理し、モード別UI設定（`getDetailedInfoUiConfig` / `getTagSummaryUiConfig`）、タグ要約描画・受け渡し（`TagSummaryRenderer`）の責務分離を進めた（見た目変更なし）
```

**OK例:**
```
FileCard 詳細情報欄の内部実装を整理した（表示への変更なし）
```

---

### 2. 関連する細かい修正はまとめて一行にする

関連する細かい修正をまとめる場合も、以下の三点が読み取れる記述を維持する。「何の機能か」「どう変わったか（ユーザーへの影響）」「なぜ変えたか（目的・解決した問題）」。これらが一文に収まるなら一文でよいが、収まらない場合は二文になっても構わない。省略してよいのは実装の手段（関数名・定数値・内部パス）であり、意図や効果は省略しない。

NG（実装手段の羅列）:
- 情報欄高さを `80 / 80 / 76` に再調整し、チップ高さ・幅上限を拡張
NG（省略しすぎ）:
- FileCard の表示バランスを調整
OK（意図と影響が残っている）:
- FileCard 各モードの情報欄・タグチップの余白とサイズを調整し、バッジ化後に情報が詰まって見える問題を改善
---

### 3. 内部識別子・パス・定数値は書かない

変数名、関数名、IPC名、ファイルパス、数値定数などは CHANGELOG には不要。どうしても残す必要がある場合はコードコメントか別ドキュメントに記載する。

---

### 4. リリース時に [Unreleased] を整理してから昇格させる

バージョン番号付きセクションへ昇格させる前に、以下を行う。

- 粒度の細かい項目を統合・圧縮する
- 実装詳細のみの記述は削除または簡潔に書き直す
- 同じ機能への追記が複数ある場合は一項目にまとめる

---

## セクション構成

Changed / Fixed / Added の三種を基本とし、それ以外のセクションは原則追加しない。
---

# セッション終了時の作業ルール（Codex向け）

## 必須手順

作業が完了したら、以下を必ずこの順番で実施する。

### 1. ドキュメントの更新

- 完了したタスクを ROADMAP の「進行中」から削除し、CHANGELOG の該当バージョンセクションに追記する
- 新たに判明した課題・今後の方針変更があれば ROADMAP の「予定」または Backlog を更新する
- 不具合・要望リスト.mdも確認して更新すること
- AGENTS.md 自体に変更が必要な場合はあわせて修正する

### 2. コミット

コミットは以下の形式で行う。

**形式:**
```
[種別] 変更内容の要約（日本語）

- 変更点1
- 変更点2
```

**種別の定義:**
- `[機能追加]` 新しい機能の追加
- `[改善]` 既存機能の改善・調整
- `[修正]` バグ・不具合の修正
- `[整理]` リファクタリング・ドキュメント整理（動作変更なし）

コミットメッセージはすべて日本語で記述する。要約行は体言止めではなく「〜を追加」「〜を修正」のように動詞で締める。

**NG例:**
```
update FileCard
```

**OK例:**
```
[改善] FileCard 各モードの情報欄レイアウトを調整

- バッジ化後に情報が詰まって見える問題を改善
- タグチップの幅上限と表示文字量を拡張
```

### 3. プッシュ

コミット後は必ずリモートへプッシュする。プッシュ前に以下を確認する。

- CHANGELOG と ROADMAP の更新がコミットに含まれているか
- 意図しないファイルがステージングに含まれていないか（`git status` で確認）

---

## 注意事項

- ドキュメント更新・コミット・プッシュのいずれかを省略しない
- 「とりあえずコミットして後で直す」という運用はしない
- 作業が中断になる場合は、その時点の状態をコミットしてから中断し、コミットメッセージに「（作業中断）」と明記する

- ライトボックスの設計方針は `docs/dev/lightbox-redesign-v2.md` に従うこと
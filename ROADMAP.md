# Roadmap

MediaArchiver v2 の開発ロードマップです。

---

## ✅ 完了済み (Completed)

### Phase 0: 再構築準備
- [x] v1の問題点分析（点滅問題、設計の不透明さ）
- [x] 流用可能なロジック資産の特定
- [x] 再構築方針の決定

### Phase 1: プロジェクト基盤構築
- [x] ドキュメント整備 (ARCHITECTURE, CONVENTIONS, Glossary)
- [x] Vite + Electron + TypeScript プロジェクト初期化
- [x] Zustand ストア基本設計
- [x] SQLite データベーススキーマ設計
- [x] IPC通信基盤の構築

### Phase 2: コア機能実装
- [x] Phase 2-1: フォルダスキャン機能
- [x] Phase 2-2: ファイル操作系 (openExternal, showInExplorer)
- [x] Phase 2-3: UI連携 (Sidebar, FileGrid, FileCard, TanStack Virtual)
- [x] Phase 2-4: サムネイル生成 (FFmpeg/Sharp)

### Phase 3: UI機能拡張
- [x] Phase 3-1: サイドバー開閉機構
- [x] Phase 3-2: フォルダ右クリックメニュー（削除、再スキャン）
- [x] Phase 3-3: ファイルソート機能
- [x] Phase 3-4: LightBox（クイックプレビュー）
- [x] Phase 3-5: ファイルコンテキストメニュー

### Phase 4: アーカイブ対応
- [x] 書庫ファイル処理（v1からarchiveHandler移植）
- [x] 書庫内プレビュー

### Phase 5: 機能拡張
- [x] Phase 5-1: タグ管理システム（CRUD、フィルターパネル、管理モーダル）
- [x] Phase 5-2: タグフィルタリング（AND/OR モード）
- [x] Phase 5-3: 検索機能（ファイル名部分一致、デバウンス）
- [x] Phase 5-4: 設定画面（サムネイルサイズ、音量、ホバー動作）

### Phase 6: プロファイル・高度な機能
- [x] プロファイル切り替え（DB分割方式）
- [x] サムネイルホバー動作（scrub/play 実装）

### Phase 7: ブラッシュアップ
- [x] 7-1: キーボードショートカット（矢印キー、Ctrl/Shift選択、Space、Delete）
- [x] 7-2: パフォーマンス最適化
  - スキャン進捗表示（ScanProgressBar、統計、キャンセル機能）
  - パフォーマンスモード設定（ホバーアニメーション制御）
  - 起動時自動スキャン設定
  - 書庫サムネイル改善（タイムアウト、エラー判定、フォールバック）
- [x] 7-3: アニメーション・マイクロインタラクション

### Phase 8: データ整合性の強化 🔧
- [x] 8-1: サムネイル・プレビューフレームの自動削除
- [x] 8-2: トランザクション処理の導入
- [x] 8-3: エラーログシステムの実装

### Phase 9: コア機能の拡張 🚀
- [x] 9-1: 音声ファイル対応
- [x] 9-2: ファイルハッシュ計算と重複検出 ✅
- [x] 9-3: 「すべてのファイル」ビュー
- [x] 9-4: メモ機能

---

## 🚧 進行中 (In Progress)

(なし)

---

## 🔥 緊急不具合修正 (Critical Bugs)
**優先度**: 最高 - 次期実装で最優先対応

> [!NOTE]
> **次回セッションの方針 (2026-02-05)**  
> 不具合修正は**一つずつ個別に取り組む**こととする。  
> 複数の不具合を同時に修正すると、リグレッションの原因特定が困難になるため、  
> 各不具合の修正→検証→コミットのサイクルを確実に実施する。

- [x] 🐛 Lightbox表示問題の修正
  - メディアが画面からはみ出す問題の解決
  - `object-fit: contain` + `max-width/max-height` の適切な適用
  - **優先度**: 最高
  - **影響範囲**: UI表示全般
  - **完了日**: 2026-02-06

- [x] 🐛 書庫内音声ファイル音量設定の保存
  - 設定ストアの音量設定を書庫内音声再生に反映
  - **優先度**: 高
  - **影響範囲**: 書庫内音声再生
  - **完了日**: 2026-02-06

> [!NOTE]
> **将来対応検討 (Future Enhancement)**  
> 動画音量と音声音量の独立化を検討。  
> 現状は共通の `videoVolume` を使用しているが、ユースケースに応じて  
> 動画とBGM的な書庫内音声で異なる音量設定が望ましい可能性がある。  
> ユーザーフィードバックを得てから対応を判断する。

- [x] 🐛 書庫内複数フォルダ対応
  - 再帰的なファイル探索の実装
  - 複数階層の書庫ファイルに対応
  - **優先度**: 中
  - **影響範囲**: 書庫内複数階層構造
  - **状態**: 既に実装済み（7zaの`l`コマンドが再帰的に動作）
  - **影響範囲**: archiveHandler.ts

---

## 📋 予定 (Planned)

> [!NOTE]
> **Phase 8-11 は完了済みです**  
> 詳細は上部の「✅ 完了済み (Completed)」セクションを参照してください。  
> このセクションは参照用として残しています。

---

### Phase 12-A: UI/UX改善（データ非破壊） 🎨
**目的**: ユーザー体験の向上  
**特性**: 状態・データ非破壊、低リスク

- [x] 12-1: トースト通知システム
  - useToastStore の作成
  - App.tsx への ToastContainer 統合
  - スキャン完了時のトースト通知
  - **完了日**: 2026-02-06
  - エラー・成功メッセージの画面表示
  - 非侵入型の通知UI
  - 通知履歴の表示
  - **リスク**: 低（表示のみ）

- [x] 12-2: タグ表示の改善 ✅
  - タグの省略表示とPop-over展開（絶対配置でレイアウト保護）
  - タグカテゴリ別の色分け強化（categoryColorで動的ボーダー）
  - タグの優先順位表示（sortOrderでuseMemoソート）

- [ ] 12-3: ファイルカード表示のカスタマイズ
  - カードサイズ・レイアウト可変設定
  - 表示内容のカスタマイズ（メタデータ表示項目選択）
  - コンパクトモード/詳細モード切り替え
  - **リスク**: 低（設定保存のみ）

- [ ] 12-4: フォルダビュー拡張
  - フォルダカード表示
  - フォルダサムネイル（代表画像）
  - **リスク**: 低（表示のみ）

- [ ] 12-5: プレビュー機能強化
  - スクラブモード時のシークバー表示
  - 動画プレビューの再生速度調整
  - 画像比較モード（2枚並べて表示）
  - **リスク**: 中（再描画パフォーマンスに注意）

- [ ] 12-11: 設定アイコンの視認性向上
  - サイドバーに歯車アイコン + "設定" ラベル表示
  - アクセスしやすい配置
  - **リスク**: 低（UI追加のみ）

- [ ] 12-12: サムネイルアスペクト比対応
  - 縦長・横長・正方形サムネイルの最適表示
  - アスペクト比保持設定
  - **リスク**: 中（仮想スクロールへの影響に注意）
  - **制約**: 固定高さを維持すること（TanStack Virtual要件）

- [ ] 12-13: サムネイル自動パラパラモード
  - ホバー時の自動シーク再生モード追加
  - スクラブモードとの切り替え設定
  - **リスク**: 高（ホバー時の状態更新に注意）
  - **制約**: hover時の再描画を最小限に抑えること
  - **制約**: スクラブモードとの排他制御が必要

- [ ] 12-14: スキャン進捗表示のアニメーション改善
  - スライドイン/アウトアニメーション
  - サイドバー下部にトグルボタン配置
  - 手動での表示/非表示切り替え
  - **リスク**: 低（アニメーションのみ）

- [ ] 12-15: 音声書庫ファイルのアイコン変更
  - 音声ファイル含有書庫の専用アイコン
  - 視覚的な識別性向上
  - **リスク**: 低（アイコン表示のみ）

---

### Phase 12-B: UI/UX改善（データ操作含む） ⚠️
**目的**: 高度なUI機能とデータ操作  
**特性**: データ破壊の可能性あり、慎重な実装が必要

- [ ] 12-6: ストレージクリーンアップ（Orphaned Thumbnail GC）
  - DBに存在しないサムネイルの検出・削除
  - 設定画面からの手動トリガー
  - 削除対象のプレビュー表示
  - **リスク**: 高（ファイル削除を伴う）
  - **制約**: 実行前プレビュー必須
  - **制約**: Undo不可（削除は不可逆）
  - **制約**: 自動実行禁止（手動トリガーのみ）

- [ ] 12-7: 外部アプリ複数設定機能
  - 複数の外部アプリケーションを登録可能に
  - 右クリックメニューに登録済みアプリを表示
  - 設定画面でアプリパスを管理
  - **リスク**: 中（設定データの管理）

- [ ] 12-8: タグ管理機能の拡張
  - タグアイコン設定
  - タグ説明文の追加
  - ファイル名・フォルダ名からの自動タグ割り当て
  - タグ検索機能の強化
  - **リスク**: 中（自動割り当ては慎重に）

- [ ] 12-9: サイドバータグリストの展開/収納機能
  - カテゴリ別の展開/収納ギミック
  - 選択中タグの強調表示
  - カテゴリ折りたたみ時も選択タグは表示
  - **リスク**: 低（状態管理のみ）

- [ ] 12-10: ファイルカードのグループ表示
  - 年・月別グループ化表示
  - グループヘッダーの追加
  - 仮想スクロール対応
  - **リスク**: 中（仮想スクロールの複雑化）



---

## 🔮 将来構想 (Backlog)

> [!WARNING]
> **Phase 13以降の機能は現行アーキテクチャの大幅な変更を伴います**  
> これらの機能は現在のフェーズ（Phase 1-12）とは要求レベルが大きく異なります。  
> 実装前に以下を確認してください:
> - 現行アーキテクチャの前提を破らないこと
> - 既存機能への影響を最小限に抑えること
> - 必要に応じてアーキテクチャの再設計を検討すること

### 高度な機能（Phase 13以降）

**パフォーマンス・安定性強化:**
- Worker Thread / Utility Process による重い処理の分離
  - ハッシュ計算、サムネイル生成を別スレッド化
  - MainプロセスのIPCレスポンス向上
  - UIフリーズの完全防止
- SQLite FTS5 (Full-Text Search) の導入
  - 大規模ライブラリでの高速検索（数万件でもサクサク）
  - ファイル名・メモの全文検索
  - インデックスによる爆速検索
- カスタムプロトコル `media://` の導入
  - `webSecurity: false` の撤廃
  - セキュリティリスクの低減
  - ローカルファイルアクセスの安全化

**機能拡張:**

- スマートプレイリスト（条件に基づく動的リスト）
- 自動整理（ルールベースのファイル移動・リネーム）
- プラグイン機構
- クラウド同期
- AI活用（自動タグ付け、類似画像検索）
- ファイル名一括リネーム
- エクスポート機能（HTML/CSV）

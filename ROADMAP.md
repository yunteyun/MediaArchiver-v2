# ROADMAP

このファイルは「今後の計画」と「進行中の計画」を最優先で確認するための運用用ロードマップです。
詳細な過去履歴は `CHANGELOG.md` と `ROADMAP_legacy.md` を参照してください。

---

## 1. 進行中の計画 (In Progress)

- サムネイル保存管理の再設計（Step 1 完了）: 共通パス解決 `thumbnailPaths.ts` を導入。次は生成処理の全面切替と cleanup / 移行系の追従を進める
- サムネイル保存管理の再設計（Step 2 完了）: 主要な生成系（画像/動画/音声/書庫サムネイル/動画プレビュー）を新保存構造へ切替済み。次は消費系（cleanup / 統計 / 移行）の整合確認を進める
- サムネイル保存管理の再設計（Step 2 追加）: 書庫サムネイル保存を優先 WebP 化（容量削減）し、変換失敗時は元形式へフォールバックするよう改善
- サムネイル保存管理の再設計（Step 2 追加）: 書庫プレビューフレームを WebP 化し、最終保存先を `archive-preview` 配下へ統一。書庫ごとの固定キャッシュで右サイドバー（4枚）/ Lightbox（12枚）の重複生成を削減
- サムネイル保存管理の再設計（Step 2 調整）: 書庫プレビューフレームの Lightbox 表示向けに縮小サイズを `384px` に引き上げ、品質値は比較検証の結果 `previewFrame=40` を採用

- 現在進行中の項目はここに記載（最優先で更新）
- 実装開始時に追加、完了時に `CHANGELOG.md` と本ファイルの完了欄へ反映

現在:
- サムネイル保存管理の再設計（Step 4 実質完了）: 保存場所移動/削除と移行時パス更新（`thumbnail_path` / `preview_frames`）の整合を確認済み。残りは相対パス化の優先度判断（別タスク候補）
- サムネイル保存管理の再設計（Step 5 実質完了）: 手動検証でフォルダカード代表サムネイル `404` を再現・修正し、最小回帰確認（再スキャン / 再生成 / プロファイル切替 / cleanup 後確認）を完了。以後は回帰監視で対応
- サムネイル保存管理の再設計（Step 3 補足）: 新構造での確認は概ね正常。旧構造実地確認は旧データ不在のため保留（必要時のみ再実施）
- ドキュメント整合性更新（`ROADMAP.md` / `CHANGELOG.md` / `.agent/implementation_plan.md` の現状追従、UI/cleanup修正結果の反映）
- 表示モード改善（進行中）: FileCard表示モード定義/情報欄を分離し、`標準(S/M/L)` / `動画（ワイド）` / `漫画` の調整基盤を整備。漫画モードは `2:3 + width=210` を暫定採用し、情報欄テンプレート最終調整を継続

---

## 2. 今後の計画 (Planned)

優先度の高い順に記載します。

### 直近（優先）
- ドキュメント整理の仕上げ（文字コード統一 / 重複整理 / 役割の最終固定）
- 書庫サムネイル不具合の再検証（`v1.1.3d5` 反映後の再確認）
- 必要ならビルド識別ログ（build marker）追加
- サムネイル保存管理の再設計（保存構造の統一 / クリーンアップ整合 / 統計・移行の整備）

### サムネイル保存管理（工程）
- Phase A: 現状仕様の棚卸し（生成 / 保存 / DB保持 / クリーンアップ / 統計 / 移行）
- Phase B: 保存構造の決定（プロファイル単位・種別単位・パス表現）
- Phase C: パス解決の共通化（thumbnail path resolver 追加）
- Phase D: 生成系の切替（`thumbnail.ts` / `archiveHandler.ts` / preview frames）
- Phase E: 消費系の切替（cleanup / statistics / delete / storage migration）
- Phase F: 互換・再生成方針の確認（今回はデータ損失許容を活かして簡略化可）
- Phase G: 検証（初回スキャン / 再スキャン / プロファイル切替 / 保存場所切替 / cleanup）

進捗対応（Stepとの対応）:
- Step 1 = Phase C（完了）
- Step 2 = Phase D（完了、書庫系追加調整含む）
- Step 3 = Phase E（実質完了、新構造確認は概ね正常・旧構造実地確認は保留）
- Step 4 = Phase E + 移行ロジック確認（実質完了、相対パス化は別タスク候補）
- Step 5 = Phase F-G（実質完了、以後は回帰監視）

### 次点
- リリース運用の改善（更新手順の簡素化・説明整備）
- ログ/エラー表示の分かりやすさ改善（非エンジニア向け）
- 回帰確認チェックリストの整備

### 将来実装候補（コスト / リスク簡易評価）

評価基準:
- コスト: `低 / 中 / 高 / 特大`
- リスク: `低 / 中 / 高 / 特大`（既存アーキテクチャ影響 / 性能影響 / UI複雑化 / データ破壊リスクを含む）

#### 優先度高（費用対効果が高い）

| 機能 | 概要 | コスト | リスク | 備考 |
|------|------|--------|--------|------|
| 表示モード拡張（漫画/動画/WhiteBrowser風） | コンテンツ別に最適化された表示モード | 中〜高 | 低〜中 | **一部実装済み（未調整）**。当面は優先度を落として保留でよい |
| FileCard「標準」アスペクト比の見直し | 標準/動画モード差分の再設計 or 名称見直し | 低〜中 | 低 | UI調整中心で着手しやすい |
| タグカテゴリ表示優先順位強化 | カテゴリごとの表示バランス改善 | 中 | 低〜中 | 既存タグ基盤を活用可能 |
| エクスポート（HTML/CSV） | メタデータ/一覧の出力 | 中 | 低〜中 | 読み取り中心で比較的安全 |

#### 優先度中（価値は高いが設計確認が必要）

| 機能 | 概要 | コスト | リスク | 備考 |
|------|------|--------|--------|------|
| 設定のプロファイル紐づけ | プロファイルごとに設定保持 | 中〜高 | 高 | 設定ストア/移行の整理が必要 |
| プロファイル別ファイル形式指定 | 動画のみ/漫画のみ等の対象形式制限 | 中 | 中 | スキャン/表示条件の整理が必要 |
| コンテキストメニュー「音声書庫として開く」 | 書庫を音声プレーヤーとして開く | 中 | 中 | 書庫処理分岐の追加が必要 |
| 12-13 サムネイル自動パラパラモード | 自動アニメ表示 | 中〜高 | 中〜高 | スクラブ/再生との排他制御が難所 |

#### 要設計レビュー（大型）

| 機能 | 概要 | コスト | リスク | 備考 |
|------|------|--------|--------|------|
| ffmpeg Worker / Utility Process 化 | コイル鳴き対策の根本解決 | 高 | 高 | ジョブ管理/IPC設計が必要 |
| スキャン性能改善 | バックグラウンド/プログレッシブスキャン | 高 | 高 | UI/DB/進捗整合が難しい |
| グループ表示モード描画最適化 | 仮想スクロール/遅延描画/メモ化最適化 | 高 | 高 | 表示崩れ・選択状態との整合に注意 |
| 自動整理（ルールベース移動・リネーム） | ルールで整理処理を実行 | 高 | 高 | 誤動作時の破壊リスク大 |
| AI活用（自動タグ/類似画像） | AIによる補助機能 | 高〜特大 | 高〜特大 | 推論基盤/コスト/UX設計が重い |
| プラグイン機構 / クラウド同期 | 拡張API / 同期機能 | 特大 | 特大 | セキュリティ/整合性/保守コストが大きい |

---

## 3. 直近リリース対象（Short-term Release Scope）

次回リリースに含める候補を管理します。

- [ ] 書庫サムネイル初回スキャン不具合の修正確認（`1.1.3d5` 反映後の再検証）
- [ ] ドキュメント整理（README / ROADMAP / メモ類）
- [ ] 必要な changelog 追記と devlog 記録

---

## 4. 保留・バックログ (Backlog)

- UI/UX 改善案（詳細は `docs/dev/思考メモ.md`）
- 未解決不具合・要望（詳細は `docs/dev/不具合・要望リスト.md`）
- 中長期の配布改善（インストーラー化 / 自動更新の検討）

---

## 5. 最近完了した主な項目（要約）

- サムネイル保存管理 Step 1: `electron/services/thumbnailPaths.ts` を追加し、`thumbnail.ts` / `archiveHandler.ts` / `thumbnailCleanupService.ts` / `statisticsService.ts` / `databaseManager.ts` の主要パス解決を共通化（将来のデータ保持移行に向けた準備）
- サムネイル保存管理 Step 2（主要生成系）: 画像 / 動画 / 音声 / 書庫サムネイル / 動画プレビューフレームの保存先を新ルール（プロファイル + 種別）へ切替
- サムネイル保存管理 Step 2（追加）: 書庫サムネイルを優先 WebP 保存へ変更し、容量削減と形式の一貫性を改善（変換失敗時は元形式フォールバック）
- サムネイル保存管理 Step 2（追加）: 書庫プレビューフレームを優先 WebP 保存へ変更し、最終保存先を `archive-preview` 配下へ統一
- サムネイル保存管理 Step 2（追加）: 書庫プレビューフレームの固定キャッシュを導入し、右サイドバー / Lightbox 間の重複生成を削減
- サムネイル保存管理 Step 2（最終調整）: 書庫プレビューフレームの品質値を比較検証し、`previewFrame=40`（縮小サイズ `384px`）を採用
- サムネイル品質設定（内部定数）: `image / video / archive / previewFrame` の WebP 品質値を内部定数へ分離（UI設定は未追加）
- サムネイル保存管理 Step 3（一部）: `preview_frames` の形式差（JSON配列 / カンマ区切り）を cleanup / 削除処理で両対応化
- サムネイル保存管理 Step 3（一部）: cleanup診断で旧保存構造（`thumbnails` 直下）へのフォールバックを追加（移行途中の運用向け）
- サムネイル保存管理 Step 3（追加修正）: 孤立サムネイル診断/削除で書庫プレビュー固定キャッシュ（`archive-preview`）を孤立判定対象から除外
- サムネイル保存管理 Step 4（追加修正）: 保存場所切替時の `thumbnail_path` / `preview_frames` パス更新判定を `instr()` ベースに調整（JSON配列/カンマ区切り互換）
- サムネイル保存管理 Step 5（追加修正）: フォルダカード代表サムネイル取得で、古い `thumbnail_path` による `404` を避けるため実在する候補を優先採用するよう改善
- Lightbox（書庫プレビュー）UI調整: 6枚前提のレイアウト/操作改善（取得数調整、背景クリックで段階的に戻る、情報パネル見直し）
- タグ表示改善: 右サイドバー / Lightbox のタグバッジにカテゴリ色を反映
- 表示モード基盤整理: FileCard の表示モード定義を共通レジストリ（`src/components/fileCard/displayModes.ts`）へ分離し、`FileGrid` / `SortMenu` と共有
- FileCard リファクタ: 情報欄を `FileCardInfoArea` / `FileCardInfoCompact` / `FileCardInfoDetailed` に分離し、モード別UI調整の編集範囲を縮小
- 表示モードUI改善: `標準（S/簡易）` / `標準（M）` / `標準（L）` / `動画（ワイド）` / `漫画` に整理し、表示モードメニュー定義を一元化
- 漫画モード調整: `2:3` を維持しつつ `cardWidth=210` に調整し、漫画モード専用の情報欄余白配分を追加（暫定）
- グリッド表示安定化: 表示モード切替直後のレイアウト崩れを抑えるため、仮想行サイズの再計測を追加
- アスペクト比整合修正: `FileCard` の aspect-ratio 描画化に合わせ、`動画（ワイド）` / `標準（S/簡易）` の `aspectRatio` 定義を実寸比へ修正

- dev/release の保存先・プロファイル分離
- ログ保存先の整理（保存モード追従）
- `update.bat` 同梱による ZIP 更新フロー追加
- 書庫サムネイル（`EXDEV` / `ENOENT` / 初回スキャン失敗）の修正対応
- README.md と docs/INDEX.md の再構成（利用者向け入口 + ドキュメント地図の明確化）
- Markdown ドキュメントの UTF-8 統一（node_modules/release除外）とメモ類の `docs/user` / `docs/dev` への整理
- `docs/dev/思考メモ.md` に最小Git運用ルール（通常は `codex/...` 継続 / 大規模変更のみ分岐）を追記
- `docs/dev/思考メモ.md` に作業コード番号ルール（`C001` 形式）と命名規約（`codex/c###-short-name`）を追記
- `docs/dev/思考メモ.md` にプレビューフレーム方式の比較メモ（現行1枚ずつ / 将来スプライト方式案）を追記
- `AGENTS.md` を追加し、Windows + PowerShell 環境での UTF-8 明示読み書きルールと `apply_patch` 優先ルールを記録
- タグフィルタの「タグ管理」ボタン押下時に UI が消える問題に対して `TagManagerModal` の Portal 化で表示安定化
- タグ管理モーダルの Hook 順序不整合（開閉時の `Rendered more hooks...`）を修正し、背景だけ残る状態を解消
- 開発版での `7za` 実行ファイル解決失敗（`spawn ... ENOENT`）を修正し、書庫サムネイル生成が止まる問題に対応
- 統計のサムネイル容量表示で旧保存構造へのフォールバックを追加し、移行途中の `0` 表示を緩和
- `media://` パス解釈の安定化対応

詳細は `CHANGELOG.md` を参照。

---

## 6. ドキュメントの使い分け

- `ROADMAP.md`: 今後の計画 / 進行中 / 直近リリース対象
- `CHANGELOG.md`: リリース単位の変更履歴
- `docs/INDEX.md`: ドキュメント地図（何をどこに書くか）
- `docs/user/アプリ使用メモ.md`: ユーザー向け操作・更新手順
- `docs/dev/不具合・要望リスト.md`: 未解決の不具合・要望
- `docs/dev/思考メモ.md`: 検討中アイデア（未確定）
- `.agent/devlog/YYYY-MM-DD.md`: 日次作業記録
- `ROADMAP_legacy.md`: 過去の詳細フェーズ表（退避）

---

## 7. 運用ルール（簡易）

1. 実装完了後に `CHANGELOG.md` と `ROADMAP.md` を更新する
2. 不具合は `docs/dev/不具合・要望リスト.md`、検討中は `docs/dev/思考メモ.md` に分ける
3. セッション終わりに `.agent/devlog/YYYY-MM-DD.md` を記録する

# Roadmap

MediaArchiver v2 の開発ロードマップです。

---

## ✅ 完了済み (Completed)

### Phase 0: 再構築準備
- [x] v1の問題点分析（点滅問題、設計の不透明さ）
- [x] 流用可能なロジック資産の特定
- [x] 再構築方針の決定

### Phase 1: プロジェクト基盤構築
- [x] ドキュメント整備 (ARCHITECTURE, CONVENTIONS, Glossary)
- [x] Vite + Electron + TypeScript プロジェクト初期化
- [x] Zustand ストア基本設計
- [x] SQLite データベーススキーマ設計
- [x] IPC通信基盤の構築

### Phase 2: コア機能実装
- [x] Phase 2-1: フォルダスキャン機能
- [x] Phase 2-2: ファイル操作系 (openExternal, showInExplorer)
- [x] Phase 2-3: UI連携 (Sidebar, FileGrid, FileCard, TanStack Virtual)
- [x] Phase 2-4: サムネイル生成 (FFmpeg/Sharp)

### Phase 3: UI機能拡張
- [x] Phase 3-1: サイドバー開閉機構
- [x] Phase 3-2: フォルダ右クリックメニュー（削除、再スキャン）
- [x] Phase 3-3: ファイルソート機能
- [x] Phase 3-4: LightBox（クイックプレビュー）
- [x] Phase 3-5: ファイルコンテキストメニュー

### Phase 4: アーカイブ対応
- [x] 書庫ファイル処理（v1からarchiveHandler移植）
- [x] 書庫内プレビュー

### Phase 5: 機能拡張
- [x] Phase 5-1: タグ管理システム（CRUD、フィルターパネル、管理モーダル）
- [x] Phase 5-2: タグフィルタリング（AND/OR モード）
- [x] Phase 5-3: 検索機能（ファイル名部分一致、デバウンス）
- [x] Phase 5-4: 設定画面（サムネイルサイズ、音量、ホバー動作）

### Phase 6: プロファイル・高度な機能
- [x] プロファイル切り替え（DB分割方式）
- [x] サムネイルホバー動作（scrub/play 実装）

### Phase 7: ブラッシュアップ
- [x] 7-1: キーボードショートカット（矢印キー、Ctrl/Shift選択、Space、Delete）
- [x] 7-2: パフォーマンス最適化
  - スキャン進捗表示（ScanProgressBar、統計、キャンセル機能）
  - パフォーマンスモード設定（ホバーアニメーション制御）
  - 起動時自動スキャン設定
  - 書庫サムネイル改善（タイムアウト、エラー判定、フォールバック）
- [x] 7-3: アニメーション・マイクロインタラクション

### Phase 8: データ整合性の強化 🔧
- [x] 8-1: サムネイル・プレビューフレームの自動削除
- [x] 8-2: トランザクション処理の導入
- [x] 8-3: エラーログシステムの実装

### Phase 14: 表示モードシステムとレイアウト改善
- [x] 14-1: 基盤整備 (DISPLAY_MODE_CONFIGS, zustand拡張)
- [x] 14-2: FileCardレイアウト刷新 (3行レイアウト / Compactモード)
- [x] 14-3: UI連携 (Headerへのモード切替ボタン追加)
- [x] 14-4: タグ表示改善 (展開/折りたたみ機能)
- [x] 14-5: 表示調整 (フォント最適化、グリッド固定高さ)

### Phase 9: コア機能の拡張 🚀
- [x] 9-1: 音声ファイル対応
- [x] 9-2: ファイルハッシュ計算と重複検出 ✅
- [x] 9-3: 「すべてのファイル」ビュー
- [x] 9-4: メモ機能

---

## 🚧 進行中 (In Progress)

(なし)

---

## 🔥 緊急不具合修正 (Critical Bugs)
**優先度**: 最高 - 次期実装で最優先対応

> [!NOTE]
> **次回セッションの方針 (2026-02-05)**  
> 不具合修正は**一つずつ個別に取り組む**こととする。  
> 複数の不具合を同時に修正すると、リグレッションの原因特定が困難になるため、  
> 各不具合の修正→検証→コミットのサイクルを確実に実施する。

- [x] 🐛 Lightbox表示問題の修正
  - メディアが画面からはみ出す問題の解決
  - `object-fit: contain` + `max-width/max-height` の適切な適用
  - **優先度**: 最高
  - **影響範囲**: UI表示全般
  - **完了日**: 2026-02-06

- [x] 🐛 書庫内音声ファイル音量設定の保存
  - 設定ストアの音量設定を書庫内音声再生に反映
  - **優先度**: 高
  - **影響範囲**: 書庫内音声再生
  - **完了日**: 2026-02-06

> [!NOTE]
> **将来対応検討 (Future Enhancement)**  
> 動画音量と音声音量の独立化を検討。  
> 現状は共通の `videoVolume` を使用しているが、ユースケースに応じて  
> 動画とBGM的な書庫内音声で異なる音量設定が望ましい可能性がある。  
> ユーザーフィードバックを得てから対応を判断する。

- [x] 🐛 書庫内複数フォルダ対応
  - 再帰的なファイル探索の実装
  - 複数階層の書庫ファイルに対応
  - **優先度**: 中
  - **影響範囲**: 書庫内複数階層構造
  - **状態**: 既に実装済み（7zaの`l`コマンドが再帰的に動作）
  - **影響範囲**: archiveHandler.ts

---

## 📋 予定 (Planned)

> [!NOTE]
> **Phase 8-11 は完了済みです**  
> 詳細は上部の「✅ 完了済み (Completed)」セクションを参照してください。  
> このセクションは参照用として残しています。

---

### Phase 12-A: UI/UX改善（データ非破壊） 🎨
**目的**: ユーザー体験の向上  
**特性**: 状態・データ非破壊、低リスク
> [!TIP]
> **重要資料**: [file_card_表示設計に関する将来要望まとめ.md](file_card_表示設計に関する将来要望まとめ.md)  
> 今後のUI設計思想（カード構造とサムネイル表現の分離、WhiteBrowser風表示など）がまとめられています。  
> Phase 12の実装時には必ず参照してください。

- [x] 12-1: トースト通知システム
  - useToastStore の作成
  - App.tsx への ToastContainer 統合
  - スキャン完了時のトースト通知
  - **完了日**: 2026-02-06
  - エラー・成功メッセージの画面表示
  - 非侵入型の通知UI
  - 通知履歴の表示
  - **リスク**: 低（表示のみ）

- [x] 12-2: タグ表示の改善 ✅
  - タグの省略表示とPop-over展開（絶対配置でレイアウト保護）
  - タグカテゴリ別の色分け強化（categoryColorで動的ボーダー）
  - タグの優先順位表示（sortOrderでuseMemoソート）

- [x] 12-3: ファイルカード表示のカスタマイズ
  - カードサイズ・レイアウト可変設定
  - 表示内容のカスタマイズ（メタデータ表示項目選択）
  - コンパクトモード/詳細モード切り替え
  - **完了日**: 2026-02-06
  - **リスク**: 低（設定保存のみ）

- [x] 12-4: フォルダビュー拡張 ✅
  **完了日**: 2026-02-06  
  **リスク**: 低  
  **内容**: FileGridにフォルダカードを表示し、フォルダサムネイル（代表画像）を表示する機能を追加しました。GridItem型定義、Database関数、IPCハンドラー、FolderCardコンポーネント、FileGrid統合を実装し、将来のサブフォルダ対応に備えた設計を実現しました。

- [x] 12-5a: スクラブモード時のシークバー表示 ✅
  **完了日**: 2026-02-07  
  **リスク**: 低  
  **内容**: FileCardのスクラブモード時に、現在のプレビュー位置を視覚的に表示するシークバーを追加しました。段階的実装戦略（視認性優先→デザイン調整）により成功。シアン色（`bg-cyan-400`）で視認性を確保しています。

- [x] 12-11: 設定アイコンの視認性向上 ✅
  - Header右上の古い設定ボタンを削除（サイドバーに移設済み）
  - **完了日**: 2026-02-07
  - **リスク**: 低（UI削除のみ）

- [ ] 12-12: サムネイルアスペクト比対応 ⏸️ **保留**
  - 縦長・横長・正方形サムネイルの最適表示
  - アスペクト比保持設定
  - **保留理由**: カード構造の大幅な変更が必要（カード幅の可変化など）
  - **将来対応**: 「表示モード」機能実装時に設計をすり合わせて再検討
  - **参考**: [file_card_表示設計に関する将来要望まとめ.md](file_card_表示設計に関する将来要望まとめ.md)
  - **リスク**: 中（仮想スクロールへの影響に注意）
  - **制約**: 固定高さを維持すること（TanStack Virtual要件）

- [ ] 12-13: サムネイル自動パラパラモード ⏸️ **保留**
  - ホバー時の自動シーク再生モード追加
  - スクラブモードとの切り替え設定
  - **保留理由**: FileCard挙動の大幅な変更が必要、Phase 12-12と同様の設計課題
  - **将来対応**: 「表示モード」機能実装時に設計をすり合わせて再検討
  - **参考**: [file_card_表示設計に関する将来要望まとめ.md](file_card_表示設計に関する将来要望まとめ.md)
  - **リスク**: 高（ホバー時の状態更新に注意）
  - **制約**: hover時の再描画を最小限に抑えること
  - **制約**: スクラブモードとの排他制御が必要

- [x] 12-14a: スキャン進捗表示の挙動修正 ✅
  - 閉じても再表示される不具合修正
  - 表示/非表示状態をUIStoreで管理
  - 最小化ボタン追加（サイドバーから再表示可能）
  - **完了日**: 2026-02-07
  - **リスク**: 低（状態管理のみ）

- [x] 12-14b: スキャン進捗表示のアニメーション改善 ✅
  - シマーアニメーション（進捗バー）
  - スライドイン/アウトアニメーション（左からのスライド）
  - パルス表現の改善
  - **完了日**: 2026-02-07
  - **リスク**: 低（視覚効果のみ）

- [x] 12-15: 音声書庫ファイルのアイコン変更 ✅
  - 音声書庫ファイルのアイコンを `FileMusic` に変更
  - 音声ファイルと書庫ファイルの両方が視認可能に
  - **完了日**: 2026-02-07
  - **リスク**: 低（アイコン変更のみ）
- [x] 12-16: 設定UI改善（サムネイルタブ化） ✅
  - 独立した「サムネイルタブ」の作成
  - 設定項目の再配置（サイズ、ホバー動作、プレビューフレーム数、管理機能）
  - **完了日**: 2026-02-09
  - **リスク**: 低（設定項目の移動のみ）

---

### Phase 12-B: UI/UX改善（データ操作含む） ⚠️
**目的**: 高度なUI機能とデータ操作  
**特性**: データ破壊の可能性あり、慎重な実装が必要

- [x] 12-6: ストレージクリーンアップ（Orphaned Thumbnail GC） ✅
  - 診断ロジック（DBとファイルシステムの差分検出）
  - 削除機能（確認ダイアログ付き）
  - エラーハンドリング（ロック中のファイルなど）
  - 設定画面からの手動トリガー
  - 削除対象のプレビュー表示
  - **リスク**: 高（ファイル削除を伴う）
  - **制約**: 実行前プレビュー必須
  - **制約**: Undo不可（削除は不可逆）
  - **制約**: 自動実行禁止（手動トリガーのみ）
- [x] 12-7: 外部アプリ複数設定機能 ✅
  - 複数の外部アプリケーションを登録可能に
  - 右クリックメニューに登録済みアプリを表示
  - 設定画面でアプリパスを管理
  - 拡張子フィルタリング機能
  - セキュリティ検証（パス存在確認、実行可能ファイル検証）
  - **完了日**: 2026-02-07
  - **リスク**: 中（設定データの管理）

- [x] 12-8: タグ管理機能の拡張
  - フェーズ1: アイコン・説明文・検索機能 (2026-02-07)
  - フェーズ2: 自動タグ割り当て（MVP） (2026-02-07)
    - ファイル名・フォルダ名からの自動タグ割り当て
    - ルール管理UI、一括適用ボタン

- [x] 12-9: 起動時自動スキャン設定
  - アプリ起動時に指定フォルダをバックグラウンドスキャン

- [x] 12-9: サイドバータグリストの展開/収納機能 ✅
  - カテゴリ別の展開/収納ギミック（アコーディオン形式）
  - 選択中タグの強調表示
  - カテゴリ折りたたみ時も選択タグは表示
  - 1つのカテゴリを展開すると他が自動で閉じる
  - **完了日**: 2026-02-07
  - **リスク**: 低（状態管理のみ）

- [x] 12-10: ファイルカードのグループ表示 ✅
  - 年月別・サイズ別・タイプ別グループ化表示
  - グループヘッダーの追加（件数、合計サイズ）
  - 5段階のサイズ区分（巨大/特大/大/中/小）
  - **完了日**: 2026-02-07
  - **リスク**: 低（グループ表示モードでは仮想スクロール不使用）

- [x] 12-17: ファイル削除ダイアログのUI改善 ✅
  - カスタムダイアログ実装（チェックボックス付き）
  - デフォルト: ゴミ箱に移動
  - チェックON: 完全削除（二重確認あり）
  - キーボード操作対応（Enter / Esc）
  - **完了日**: 2026-02-09
  - **リスク**: 低（UI変更のみ）

- [x] 12-18: サムネイル再作成時のスクラブサムネイル確認 ✅
  - 設定のプレビューフレーム数が0の場合はスキップ
  - ユーザーが明示的に再作成を選択した場合は常に再生成
  - コンソールログで挙動確認可能
  - **バグ修正 (2026-02-09 15:45)**: 既存フレーム数チェックを削除し、再作成時は常に再生成するように変更
  - **完了日**: 2026-02-09
  - **リスク**: 低（既存機能の改善）

---

## 🔮 将来構想 (Backlog)

> [!WARNING]
> **Phase 13以降の機能は現行アーキテクチャの大幅な変更を伴います**  
> これらの機能は現在のフェーズ（Phase 1-12）とは要求レベルが大きく異なります。  
> 実装前に以下を確認してください:
> - 現行アーキテクチャの前提を破らないこと
> - 既存機能への影響を最小限に抑えること
> - 必要に応じてアーキテクチャの再設計を検討すること

### 高度な機能（Phase 13以降）

**パフォーマンス・安定性強化:**
- Worker Thread / Utility Process による重い処理の分離
  - ハッシュ計算、サムネイル生成を別スレッド化
  - MainプロセスのIPCレスポンス向上
  - UIフリーズの完全防止
- SQLite FTS5 (Full-Text Search) の導入
  - 大規模ライブラリでの高速検索（数万件でもサクサク）
  - ファイル名・メモの全文検索
  - インデックスによる爆速検索

**Phase 13: FileCard 基礎設計** �️

> [!IMPORTANT]
> **Phase 13 は「見た目を作り込むフェーズ」ではなく「構造と責務を固定するフェーズ」**  
> FileCard の拡張可能な基盤を確立し、Phase 14 以降の機能追加を安全に行えるようにします。

**設計思想**:
- [file_card_表示設計に関する将来要望まとめ.md](file_card_表示設計に関する将来要望まとめ.md) に基づく
- カード構造（表示モード）とサムネイル表現（アスペクト比・挙動）の完全分離
- 「一覧を見て内容が分かる」体験の実現（Phase 14 以降で本格実装）

---

#### 13-1: 画像ファイルの扱い
- `mediaType`: image | video | audio | archive（既存）
- `isAnimated`: boolean（image のみ有効）を追加
- 静止/アニメーション画像は分離せず、同一カテゴリとして扱う
- アニメーション判定はサムネイル再生有無とは独立

#### 13-2: FileCard 表示情報（デフォルト構成）

**Primary（常時表示・強調）**
- ファイル名
- ファイルサイズ

**Secondary（控えめ表示）**
- 保存フォルダ名（ドライブ名 + 最後のフォルダ名のみ）

> [!NOTE]
> タグ・再生時間などは「表示可能な項目」として設計に含めるが、
> 細かな出し分け・優先順位変更は Phase 14 以降で対応。

#### 13-3: 情報レイアウト方針
- 情報領域はサムネイル下部に下寄せ配置
- 縦積み構造（表示項目の増減に耐えられる設計）
- カード高さは固定せず、`min-height` のみ定義
- 実際のサイズ最適化は後続フェーズで調整

#### 13-4: タグ表示ルール
- カテゴリごとに表示優先順位を持たせる
- 上位 N 個を常時表示（N を超える分は `+X` 形式で省略）
- クリックで全タグ展開（Phase 12-2 の Pop-over 方式と整合）

#### 13-5: 配色ルール（決め切らない）
- ファイル種別（画像/動画など）はバッジ配色で識別可能にする
- 配色はデザイントークンとして管理（後から調整可能な構造）
- サムネイルを主役とし、タグ・バッジは視認性優先で控えめに

---

- [x] **FileCard 基礎設計** (Phase 13)
   - [x] 画像ファイルの扱い改善 (`isAnimated`)
   - [x] UIユーティリティ分離 (`path.ts`, `tag.ts`)
   - [x] 情報レイアウト刷新 (下寄せ・縦積み)
   - [x] タグ表示視認性改善 (Phase 13.5)
   - [x] 配色ルール（デザイントークン）

---

**Phase 14: 表示モードシステム** 🎨 (In Progress)

> [!NOTE]
> MVP（最小限）から開始し、動作確認後に段階的に拡張します。

**実装予定機能 (MVP)**:
1. 基盤整備（設定ストア、定数定義）
2. 標準モードの確立
3. UI切り替え（ヘッダー）

**将来的な拡張**:
- 漫画モード（縦長）
- 動画モード（横長）
- WhiteBrowser風モード

---



**実装予定機能**:

- **ffmpeg Worker/Utility Process 化**
  - 目的: プレビューフレーム生成時のコイル鳴きを完全解決
  - ffmpeg プロセスを Worker または Utility Process として常駐化
  - 連続デコードにより瞬間負荷スパイクを回避
  - 現状: `-threads 1` で軽減済み、一部の重い動画では依然として発生
  - 詳細: `CONVENTIONS.md` の「既知の技術的制約と対策」を参照

- **スキャンパフォーマンスの改善**
  - バックグラウンドスキャンの実装
  - プログレッシブスキャン（大量ファイル対応）
  - キャッシュ最適化

---

**機能拡張:**

- **テーマカスタマイズ機能**
  - CSS変数ベースのカラーパレット管理
  - アクセントカラー選択（シークバー、ボタンなど）
  - プリセットテーマ（ダーク/ライト/シアン/アンバー/グリーンなど）
  - 設定画面でのカラーピッカー
- スマートプレイリスト（条件に基づく動的リスト）
- 自動整理（ルールベースのファイル移動・リネーム）
- プラグイン機構
- クラウド同期
- AI活用（自動タグ付け、類似画像検索）
- ファイル名一括リネーム
- エクスポート機能（HTML/CSV）

**プレビュー機能のアイデア（Phase 12-5b/5c）:**
- 動画プレビューの再生速度調整（0.5x, 1x, 1.5x, 2x）
- 画像比較モード（2枚並べて表示、左右独立ズーム）

# 開発日誌 2026-02-18

## 本日の目標
- Phase 25（保存場所カスタマイズ）の実装
- v1.1.0 リリース

---

## 実装した機能

### Phase 25: 保存場所カスタマイズ

**実装内容**:
- `storageConfig.ts` 新規作成
  - 二段階ロード（userData → basePath の順に設定ファイルを読む）
  - `initStorageConfig()`: 起動時に DB 初期化より前に呼び出す
  - `migrateStorage()`: 原子的移行（tmp フォルダ経由 → rename）
  - `checkWritePermission()`: 書き込み権限確認
  - `deleteOldStorageData()`: 旧データ削除（profiles.db は除外）
  - `updateThumbnailPathsInDbs()`: 移行後に DB の thumbnail_path / preview_frames を新パスに一括更新
- `electron/ipc/storage.ts` 新規作成
  - `storage:getConfig` / `storage:setConfig` / `storage:browseFolder` / `storage:deleteOldData`
- `thumbnail.ts`: `THUMBNAIL_DIR` 定数 → `getThumbnailDir()` 動的取得（4箇所）
- `archiveHandler.ts`: `THUMBNAIL_DIR`・`TEMP_DIR` 定数 → 動的取得関数
- `databaseManager.ts`: `getBasePath()` 動的取得、`walCheckpoint()`・`closeAll()`・`reopenMetaDb()` 追加
- `SettingsModal.tsx`: サムネイルタブに「保存場所」セクション追加

**バグ修正**:
1. `closeAll()` 後に `metaDb` が閉じられたまま `initialize()` を呼ぶと「connection is not open」エラー
   → `reopenMetaDb()` メソッドを追加し、`initialize()` 前に呼ぶよう修正
2. `deleteOldStorageData` で `profiles.db` を削除しようとして EBUSY エラー
   → `profiles.db` を削除対象から除外
3. 移行後にサムネイルが表示されない
   → `updateThumbnailPathsInDbs()` で DB の thumbnail_path を新パスに一括 REPLACE

### v1.1.0 リリース

**手順**:
1. `dist/dist-electron` クリーン削除
2. `npm run build`（Vite ビルド成功）
3. CHANGELOG.md に `[1.1.0]` + `[dev-25]` エントリ追加
4. `package.json` バージョン `1.0.0` → `1.1.0`
5. `win.target` を `dir` → `zip` に変更
6. `npm run build:electron`（`MediaArchiver v2-1.1.0-win.zip` 生成）
7. `README.txt` 作成・ZIP に同梱（起動方法・SmartScreen 警告・ポータブル説明）
8. `git tag -a v1.1.0 -m "Release v1.1.0"` コミット

---

## 成果

- ✅ Phase 25 完了
- ✅ v1.1.0 リリース（`release/MediaArchiver v2-1.1.0-win.zip`）
- TypeScript ビルドエラーなし

---

## 学んだこと・気づき

- `better-sqlite3` の `Database` インスタンスは `close()` 後に再利用できない。`closeAll()` で metaDb を閉じると次の `initialize()` で失敗する。再接続用メソッドを用意しておくことが重要。
- SQLite の `REPLACE(col, old, new)` は大文字小文字を区別する。Windows のパス区切り文字（`\` と `/`）が混在するため、両方のパターンで置換する必要がある。
- electron-builder の `zip` ターゲットは `dir` より時間がかかるが、配布しやすい形式。

---

## 次回の予定

- Phase 26: タグ構造刷新（二層カテゴリ構造・評価軸の物理的分離）
- 追加表示モード（漫画モード・動画モード）
